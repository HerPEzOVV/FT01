<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ГНК КИППТ // Секретный архив</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚠️</text></svg>">
    <style>
        body {
            background-color: #0A1A2F;
            color: #00FF00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            border: 1px solid #2A2A2A;
            padding: 20px;
            background-color: #000000;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.1);
        }
        
        .header {
            border-bottom: 2px solid #8B0000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #8B0000;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0;
        }
        
        .header h2 {
            color: #2A2A2A;
            font-size: 12px;
            margin: 5px 0 0 0;
        }
        
        .login-screen {
            text-align: center;
            padding: 50px 20px;
        }
        
        .login-screen input {
            background: #000;
            border: 1px solid #00FF00;
            color: #00FF00;
            padding: 10px;
            font-family: 'Courier New', monospace;
            width: 250px;
            margin: 15px 0;
            font-size: 16px;
            letter-spacing: 1px;
        }
        
        .login-screen button {
            background: #8B0000;
            color: white;
            border: none;
            padding: 12px 25px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            margin-top: 10px;
        }
        
        .login-screen button:hover {
            background: #A00000;
        }
        
        .error {
            color: #FF0000;
            margin: 15px 0;
            min-height: 20px;
            font-weight: bold;
        }
        
        .success {
            color: #00FF00;
            margin: 15px 0;
            min-height: 20px;
        }
        
        .menu {
            background: #0A1A2F;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #2A2A2A;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .menu a {
            color: #00FF00;
            text-decoration: none;
            padding: 5px 10px;
            border: 1px solid transparent;
            white-space: nowrap;
        }
        
        .menu a:hover {
            border: 1px solid #8B0000;
        }
        
        .content {
            min-height: 400px;
            padding: 10px;
        }
        
        .log-entry {
            border: 1px dashed #2A2A2A;
            margin: 20px 0;
            padding: 15px;
            background: rgba(10, 26, 47, 0.3);
            position: relative;
        }
        
        .log-entry h3 {
            color: #8B0000;
            margin-top: 0;
            border-bottom: 1px solid #2A2A2A;
            padding-bottom: 8px;
        }
        
        .log-entry .date {
            color: #2A2A2A;
            font-size: 11px;
            margin: 5px 0;
        }
        
        .add-form {
            background: #0A1A2F;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #2A2A2A;
        }
        
        .add-form input, .add-form textarea, .add-form select {
            background: #000;
            border: 1px solid #00FF00;
            color: #00FF00;
            padding: 10px;
            font-family: 'Courier New', monospace;
            width: 100%;
            margin: 8px 0;
            box-sizing: border-box;
        }
        
        .add-form textarea {
            height: 200px;
            resize: vertical;
        }
        
        .add-form button {
            background: #8B0000;
            color: white;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .add-form button:hover {
            background: #A00000;
        }
        
        .footer {
            border-top: 1px solid #2A2A2A;
            margin-top: 30px;
            padding-top: 15px;
            color: #2A2A2A;
            font-size: 11px;
            text-align: center;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .status-bar {
            background: #000;
            padding: 8px;
            border: 1px solid #2A2A2A;
            font-size: 12px;
            margin-bottom: 15px;
            color: #2A2A2A;
        }
        
        .tag {
            display: inline-block;
            background: #2A2A2A;
            color: #8B0000;
            padding: 2px 6px;
            font-size: 10px;
            margin-right: 5px;
            margin-bottom: 3px;
        }
        
        .config-section {
            background: rgba(42, 42, 42, 0.5);
            padding: 20px;
            margin: 20px 0;
            border: 1px dashed #8B0000;
        }
        
        .config-section input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #000;
            border: 1px solid #00FF00;
            color: #00FF00;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #0A1A2F;
            border: 1px solid #2A2A2A;
            padding: 10px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .sync-btn {
            background: #2A2A2A !important;
            color: #00FF00 !important;
        }
        
        .sync-btn.syncing {
            background: #8B0000 !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #2A2A2A;
            color: #8B0000;
            border: none;
            padding: 3px 8px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .delete-btn:hover {
            background: #8B0000;
            color: white;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .menu {
                flex-direction: column;
            }
            
            .login-screen input {
                width: 90%;
            }
            
            .sync-status {
                position: static;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <!-- Экран входа -->
        <div class="login-screen" id="loginScreen">
            <div class="header">
                <h1>◼◼◼◼◼◼◼◼◼◼◼◼◼ "◼◼◼◼"</h1>
                <h2>закрытый исследовательский сервер // версия 2.0</h2>
            </div>
            <p>⚠️ ВНИМАНИЕ: СИСТЕМА СИНХРОНИЗАЦИИ С ГИТХАБ ⚠️</p>
            <p>Введите кодовое слово для авторизации:</p>
            <input type="password" id="passwordInput" placeholder="███████ █████" autocomplete="off" autofocus>
            <br>
            <button onclick="checkPassword()">ПОДТВЕРДИТЬ</button>
            <div class="error" id="errorMsg"></div>
            <div class="footer">
                СИСТЕМА СИНХРОНИЗАЦИИ: ГОТОВА<br>
                <span id="accessCodeHint">Подсказка: Событие "████ ██████"</span>
            </div>
        </div>
        
        <!-- Основной интерфейс -->
        <div id="mainInterface" style="display:none;">
            <div class="header">
                <h1>СЕКРЕТНЫЙ АРХИВ // СИНХРОНИЗАЦИЯ С ГИТХАБ</h1>
                <h2><span id="currentTime">--:--:--</span> | РЕПО: <span id="repoStatus" class="blink">● ПРОВЕРКА</span></h2>
            </div>
            
            <div class="status-bar">
                > СИСТЕМА: GitHub Pages + API | РЕЖИМ: <span id="syncMode">ЛОКАЛЬНЫЙ</span> | ЗАПИСЕЙ: <span id="logsCount">0</span>
            </div>
            
            <div class="menu">
                <a href="#" onclick="showSection('logs')" id="navLogs">● ЗАПИСИ</a>
                <a href="#" onclick="showSection('add')" id="navAdd">+ ДОБАВИТЬ</a>
                <a href="#" onclick="showSection('sync')" id="navSync">↻ СИНХРОНИЗАЦИЯ</a>
                <a href="#" onclick="showSection('config')" id="navConfig">⚙ НАСТРОЙКИ ГИТХАБ</a>
                <a href="#" onclick="logout()" style="color:#8B0000;margin-left:auto;">✖ ВЫХОД</a>
            </div>
            
            <div class="content" id="content">
                <!-- Контент загружается здесь -->
            </div>
            
            <div class="footer">
                ГНК КИППТ © 1995-1996 | СИНХРОНИЗАЦИЯ С РЕПОЗИТОРИЕМ<br>
                ВЕРСИЯ: 2.0 | ПОСЛЕДНЯЯ СИНХРОНИЗАЦИЯ: <span id="lastSync">НИКОГДА</span>
            </div>
        </div>
    </div>

    <!-- Панель статуса синхронизации -->
    <div class="sync-status" id="syncStatus">
        <div id="syncMessage">● ГОТОВО К СИНХРОНИЗАЦИИ</div>
    </div>

    <script>
        // Конфигурация
        const CONFIG = {
            PASSWORD: "ШифрЗима",
            STORAGE_KEY: "kippt_github_config",
            DATA_FILE: "kippt_data.json",
            VERSION: "2.0"
        };
        
        // Настройки GitHub
        let githubConfig = {
            token: "",
            username: "",
            repo: "",
            branch: "main",
            enabled: false
        };
        
        // Данные архива
        let archiveData = {
            logs: [],
            lastModified: null,
            version: CONFIG.VERSION,
            syncHistory: []
        };
        
        // Статус синхронизации
        let syncState = {
            isSyncing: false,
            lastSync: null,
            autoSync: false
        };
        
        // Основная функция инициализации
        function init() {
            loadConfig();
            loadLocalData();
            setupEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Подсказка пароля
            setTimeout(() => {
                const hintEl = document.getElementById('accessCodeHint');
                if (hintEl) {
                    hintEl.textContent = "Подсказка: Событие 'Шифр Зима'";
                }
            }, 3000);
        }
        
        // Загрузить конфигурацию
        function loadConfig() {
            try {
                const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (saved) {
                    githubConfig = JSON.parse(saved);
                }
            } catch (e) {
                console.error("Ошибка загрузки конфигурации:", e);
            }
        }
        
        // Сохранить конфигурацию
        function saveConfig() {
            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(githubConfig));
            } catch (e) {
                console.error("Ошибка сохранения конфигурации:", e);
            }
        }
        
        // Загрузить локальные данные
        function loadLocalData() {
            try {
                const saved = localStorage.getItem("kippt_local_data");
                if (saved) {
                    archiveData = JSON.parse(saved);
                    updateLogsCount();
                    updateLastSyncTime();
                } else {
                    createInitialLogs();
                    saveLocalData();
                }
            } catch (e) {
                console.error("Ошибка загрузки данных:", e);
                createInitialLogs();
                saveLocalData();
            }
        }
        
        // Сохранить локальные данные
        function saveLocalData() {
            try {
                localStorage.setItem("kippt_local_data", JSON.stringify(archiveData));
                updateLogsCount();
            } catch (e) {
                console.error("Ошибка сохранения данных:", e);
                showError("Ошибка сохранения локальных данных");
            }
        }
        
        // Создать начальные записи
        function createInitialLogs() {
            archiveData = {
                logs: [
                    {
                        id: generateId(),
                        title: "СИСТЕМА СИНХРОНИЗАЦИИ АКТИВИРОВАНА",
                        date: getCurrentDate(),
                        content: "Архив ГНК КИППТ переведен на систему синхронизации с GitHub репозиторием. Все новые записи будут сохраняться как файлы в репозитории. Старые записи перенесены автоматически.",
                        tags: ["СИСТЕМА", "СИНХРОНИЗАЦИЯ", "ГИТХАБ"],
                        author: "СИСТЕМНЫЙ АДМИНИСТРАТОР",
                        priority: "HIGH"
                    },
                    {
                        id: generateId(),
                        title: "ИНСТРУКЦИЯ: РАБОТА С СИНХРОНИЗАЦИЕЙ",
                        date: getCurrentDate(),
                        content: "1. Настройте доступ к GitHub в разделе 'НАСТРОЙКИ ГИТХАБ'\n2. Укажите Personal Access Token, имя пользователя и репозиторий\n3. Используйте кнопку 'СИНХРОНИЗИРОВАТЬ' для загрузки/выгрузки данных\n4. Все записи хранятся в файле kippt_data.json в репозитории\n5. Рекомендуется синхронизировать данные после каждого изменения",
                        tags: ["ИНСТРУКЦИЯ", "СИНХРОНИЗАЦИЯ", "ГИТХАБ"],
                        author: "СИСТЕМНЫЙ АДМИНИСТРАТОР",
                        priority: "MEDIUM"
                    }
                ],
                lastModified: new Date().toISOString(),
                version: CONFIG.VERSION,
                syncHistory: []
            };
        }
        
        // Проверка пароля
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('errorMsg');
            
            if (input === CONFIG.PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainInterface').style.display = 'block';
                showSection('logs');
                
                // Анимация появления
                const mainInterface = document.getElementById('mainInterface');
                mainInterface.style.opacity = '0';
                mainInterface.style.transition = 'opacity 0.5s';
                setTimeout(() => mainInterface.style.opacity = '1', 10);
                
                // Проверяем GitHub конфигурацию
                setTimeout(checkGitHubConfig, 500);
                
            } else {
                errorMsg.textContent = "⨯ НЕВЕРНЫЙ КОД. ДОСТУП ЗАПРЕЩЕН.";
                errorMsg.style.color = "#FF0000";
                
                // Анимация ошибки
                const container = document.getElementById('container');
                container.style.animation = 'none';
                setTimeout(() => {
                    container.style.animation = 'shake 0.5s';
                }, 10);
                
                setTimeout(() => {
                    document.getElementById('passwordInput').value = '';
                }, 1000);
            }
        }
        
        // Выход
        function logout() {
            if (confirm("Завершить сеанс доступа?")) {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainInterface').style.display = 'none';
                document.getElementById('passwordInput').value = '';
                const errorMsg = document.getElementById('errorMsg');
                if (errorMsg) errorMsg.textContent = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // Показать секцию
        function showSection(section) {
            // Обновляем навигацию
            document.querySelectorAll('.menu a').forEach(a => {
                a.style.backgroundColor = 'transparent';
            });
            
            const content = document.getElementById('content');
            if (!content) return;
            
            switch(section) {
                case 'logs':
                    const navLogs = document.getElementById('navLogs');
                    if (navLogs) navLogs.style.backgroundColor = '#2A2A2A';
                    showLogsSection();
                    break;
                    
                case 'add':
                    const navAdd = document.getElementById('navAdd');
                    if (navAdd) navAdd.style.backgroundColor = '#2A2A2A';
                    showAddSection();
                    break;
                    
                case 'sync':
                    const navSync = document.getElementById('navSync');
                    if (navSync) navSync.style.backgroundColor = '#2A2A2A';
                    showSyncSection();
                    break;
                    
                case 'config':
                    const navConfig = document.getElementById('navConfig');
                    if (navConfig) navConfig.style.backgroundColor = '#2A2A2A';
                    showConfigSection();
                    break;
            }
        }
        
        // Раздел с записями
        function showLogsSection() {
            const content = document.getElementById('content');
            if (!content) return;
            
            let html = `<h3>● АРХИВНЫЕ ЗАПИСИ (${archiveData.logs.length})</h3>`;
            
            if (archiveData.logs.length === 0) {
                html += '<p>Архив пуст. Добавьте первую запись.</p>';
            } else {
                // Сортируем по дате (новые сверху)
                const sortedLogs = [...archiveData.logs].sort((a, b) => 
                    new Date(b.date.split('/').reverse().join('-')) - 
                    new Date(a.date.split('/').reverse().join('-'))
                );
                
                sortedLogs.forEach(log => {
                    const tagsHtml = log.tags ? 
                        log.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ') : '';
                    
                    const priorityColor = log.priority === 'HIGH' ? '#8B0000' : 
                                        log.priority === 'MEDIUM' ? '#FFA500' : '#00FF00';
                    
                    html += `
                        <div class="log-entry">
                            <button class="delete-btn" onclick="deleteLog('${log.id}')">✖</button>
                            <h3>${log.title}</h3>
                            <div class="date">
                                ID: ${log.id} | ${log.date} | 
                                <span style="color:${priorityColor}">${log.priority || 'NORMAL'}</span>
                                ${log.author ? `| АВТОР: ${log.author}` : ''}
                            </div>
                            <div style="margin: 8px 0;">${tagsHtml}</div>
                            <p style="white-space: pre-line;">${log.content}</p>
                        </div>
                    `;
                });
            }
            
            // Кнопка синхронизации
            html += `
                <div style="text-align: center; margin: 20px;">
                    <button onclick="syncWithGitHub()" class="sync-btn" style="padding: 10px 30px;">
                        ● СИНХРОНИЗИРОВАТЬ С ГИТХАБ
                    </button>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        // Раздел добавления
        function showAddSection() {
            const content = document.getElementById('content');
            if (!content) return;
            
            const today = getCurrentDate();
            
            const html = `
                <h3>+ ДОБАВИТЬ НОВУЮ ЗАПИСЬ</h3>
                <div class="add-form">
                    <input type="text" id="newTitle" placeholder="ЗАГОЛОВОК (обязательно)" maxlength="100">
                    <input type="text" id="newDate" placeholder="ДД/ММ/ГГГГ" value="${today}">
                    <input type="text" id="newAuthor" placeholder="АВТОР (опционально)">
                    
                    <div style="display: flex; gap: 10px; margin: 8px 0;">
                        <select id="newPriority" style="flex: 1;">
                            <option value="NORMAL">НОРМАЛЬНЫЙ ПРИОРИТЕТ</option>
                            <option value="MEDIUM">СРЕДНИЙ ПРИОРИТЕТ</option>
                            <option value="HIGH">ВЫСОКИЙ ПРИОРИТЕТ</option>
                        </select>
                        <input type="text" id="newTags" placeholder="ТЕГИ (через запятую)" style="flex: 2;">
                    </div>
                    
                    <textarea id="newContent" placeholder="СОДЕРЖАНИЕ ЗАПИСИ..." maxlength="5000"></textarea>
                    
                    <div>
                        <button onclick="addNewLog()">● СОХРАНИТЬ ЛОКАЛЬНО</button>
                        <button onclick="addAndSyncLog()" style="background: #2A2A2A;">● СОХРАНИТЬ И СИНХРОНИЗИРОВАТЬ</button>
                        <button onclick="clearAddForm()" style="background: #8B0000;">✖ ОЧИСТИТЬ</button>
                    </div>
                    
                    <p style="color:#2A2A2A; font-size:11px; margin-top:15px;">
                        Запись будет сохранена локально. Используйте "СОХРАНИТЬ И СИНХРОНИЗИРОВАТЬ" 
                        для немедленной загрузки в GitHub репозиторий.
                    </p>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        // Раздел синхронизации
        function showSyncSection() {
            const content = document.getElementById('content');
            if (!content) return;
            
            const syncHistoryHtml = archiveData.syncHistory.length > 0 ?
                archiveData.syncHistory.map(entry => `
                    <div style="border-bottom: 1px dashed #2A2A2A; padding: 5px 0;">
                        ${new Date(entry.timestamp).toLocaleString()} - 
                        ${entry.action} - 
                        <span style="color: ${entry.success ? '#00FF00' : '#FF0000'}">
                            ${entry.success ? 'УСПЕХ' : 'ОШИБКА'}
                        </span>
                        ${entry.message ? `: ${entry.message}` : ''}
                    </div>
                `).join('') :
                '<p>История синхронизации пуста</p>';
            
            const html = `
                <h3>↻ СИНХРОНИЗАЦИЯ С ГИТХАБ</h3>
                
                <div class="config-section">
                    <h4>● СТАТУС СИНХРОНИЗАЦИИ</h4>
                    <p>GitHub API: <span id="githubStatus" style="color:#00FF00;">● ПРОВЕРКА...</span></p>
                    <p>Режим: <span id="currentSyncMode">${githubConfig.enabled ? 'АКТИВЕН' : 'ОТКЛЮЧЕН'}</span></p>
                    <p>Последняя синхронизация: <span id="lastSyncDetail">${syncState.lastSync ? new Date(syncState.lastSync).toLocaleString() : 'НИКОГДА'}</span></p>
                    <p>Записей для синхронизации: ${archiveData.logs.length}</p>
                    
                    <div style="margin: 20px 0;">
                        <button onclick="syncWithGitHub()" class="sync-btn" style="width: 100%; padding: 15px;">
                            ● ЗАПУСТИТЬ СИНХРОНИЗАЦИЮ
                        </button>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>● ИСТОРИЯ СИНХРОНИЗАЦИИ</h4>
                    <div style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                        ${syncHistoryHtml}
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>● БЫСТРЫЕ ДЕЙСТВИЯ</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="pullFromGitHub()">◀ ЗАГРУЗИТЬ ИЗ ГИТХАБ</button>
                        <button onclick="pushToGitHub()">▶ ВЫГРУЗИТЬ В ГИТХАБ</button>
                        <button onclick="forceResync()" style="background: #8B0000;">↻ ПРИНУДИТЕЛЬНАЯ СИНХРОНИЗАЦИЯ</button>
                        <button onclick="testGitHubConnection()" style="background: #2A2A2A;">● ТЕСТ ПОДКЛЮЧЕНИЯ</button>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            setTimeout(checkGitHubConfig, 100);
        }
        
        // Раздел настроек GitHub
        function showConfigSection() {
            const content = document.getElementById('content');
            if (!content) return;
            
            const html = `
                <h3>⚙ НАСТРОЙКИ ГИТХАБ API</h3>
                
                <div class="config-section">
                    <h4>● КОНФИГУРАЦИЯ ДОСТУПА</h4>
                    <p style="color: #8B0000; font-size: 12px;">
                        Внимание: Для работы синхронизации требуется Personal Access Token с правами repo
                    </p>
                    
                    <label>GitHub Username:</label>
                    <input type="text" id="configUsername" placeholder="Ваш GitHub username" value="${githubConfig.username || ''}">
                    
                    <label>Personal Access Token:</label>
                    <input type="password" id="configToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" value="${githubConfig.token || ''}">
                    
                    <label>Repository Name:</label>
                    <input type="text" id="configRepo" placeholder="username/repository" value="${githubConfig.repo || ''}">
                    
                    <label>Branch Name:</label>
                    <input type="text" id="configBranch" placeholder="main" value="${githubConfig.branch || 'main'}">
                    
                    <div style="margin: 20px 0;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="configEnabled" ${githubConfig.enabled ? 'checked' : ''}>
                            Включить синхронизацию с GitHub
                        </label>
                    </div>
                    
                    <div>
                        <button onclick="saveGitHubConfig()">● СОХРАНИТЬ НАСТРОЙКИ</button>
                        <button onclick="clearGitHubConfig()" style="background: #8B0000;">✖ ОЧИСТИТЬ НАСТРОЙКИ</button>
                    </div>
                </div>
                
                <div class="config-section">
                    <h4>● ИНСТРУКЦИЯ ПО ПОЛУЧЕНИЮ ТОКЕНА</h4>
                    <ol style="color: #2A2A2A; font-size: 12px; padding-left: 20px;">
                        <li>Зайдите на GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)</li>
                        <li>Нажмите "Generate new token" → "Generate new token (classic)"</li>
                        <li>Дайте токену имя (например, "KIPPT Sync")</li>
                        <li>Выберите срок действия (рекомендуется "no expiration")</li>
                        <li>Отметьте галочку "repo" (полный контроль приватных репозиториев)</li>
                        <li>Нажмите "Generate token" и скопируйте токен (начинается с ghp_)</li>
                        <li>Вставьте токен в поле выше</li>
                    </ol>
                    <p style="color: #FF0000; font-size: 11px;">
                        ⚠️ НИКОМУ НЕ ПЕРЕДАВАЙТЕ СВОЙ ТОКЕН! Он дает полный доступ к вашим репозиториям.
                    </p>
                </div>
                
                <div class="config-section">
                    <h4>● ИНФОРМАЦИЯ О СИСТЕМЕ</h4>
                    <p>Версия: ${CONFIG.VERSION}</p>
                    <p>Файл данных: ${CONFIG.DATA_FILE}</p>
                    <p>Записей в архиве: ${archiveData.logs.length}</p>
                    <p>Размер данных: ${JSON.stringify(archiveData).length} байт</p>
                    <p>Локальное хранилище: ${localStorage.getItem("kippt_local_data") ? 'ЕСТЬ ДАННЫЕ' : 'ПУСТО'}</p>
                </div>
            `;
            
            content.innerHTML = html;
        }
        
        // Добавить новую запись
        function addNewLog() {
            const log = getLogFromForm();
            if (!log) return;
            
            archiveData.logs.push(log);
            archiveData.lastModified = new Date().toISOString();
            saveLocalData();
            
            clearAddForm();
            showSection('logs');
            
            showSyncMessage(`Запись #${log.id} сохранена локально`, 'success');
        }
        
        // Добавить и синхронизировать
        async function addAndSyncLog() {
            const log = getLogFromForm();
            if (!log) return;
            
            archiveData.logs.push(log);
            archiveData.lastModified = new Date().toISOString();
            saveLocalData();
            
            clearAddForm();
            
            // Синхронизируем с GitHub
            if (githubConfig.enabled) {
                showSyncMessage("Сохранение и синхронизация...", 'syncing');
                const success = await pushToGitHub();
                if (success) {
                    showSyncMessage(`Запись #${log.id} сохранена и синхронизирована`, 'success');
                } else {
                    showSyncMessage("Запись сохранена локально, но синхронизация не удалась", 'error');
                }
            } else {
                showSyncMessage("Запись сохранена локально. Включите синхронизацию в настройках GitHub", 'warning');
            }
            
            showSection('logs');
        }
        
        // Получить данные записи из формы
        function getLogFromForm() {
            const title = document.getElementById('newTitle')?.value.trim();
            const date = document.getElementById('newDate')?.value.trim();
            const content = document.getElementById('newContent')?.value.trim();
            const author = document.getElementById('newAuthor')?.value.trim();
            const priority = document.getElementById('newPriority')?.value;
            const tagsInput = document.getElementById('newTags')?.value.trim();
            
            if (!title || !content) {
                alert("Заполните заголовок и содержание!");
                return null;
            }
            
            if (!/^\d{2}\/\d{2}\/\d{4}$/.test(date)) {
                alert("Дата должна быть в формате ДД/ММ/ГГГГ");
                return null;
            }
            
            const tags = tagsInput ? 
                tagsInput.split(',').map(tag => tag.trim().toUpperCase()).filter(tag => tag) : 
                ["АРХИВ"];
            
            return {
                id: generateId(),
                title: title.toUpperCase(),
                date: date,
                content: content,
                author: author || "НЕИЗВЕСТНЫЙ ОПЕРАТОР",
                priority: priority,
                tags: tags,
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
        }
        
        // Удалить запись
        function deleteLog(id) {
            if (confirm("Удалить эту запись? Это действие необратимо.")) {
                archiveData.logs = archiveData.logs.filter(log => log.id !== id);
                archiveData.lastModified = new Date().toISOString();
                saveLocalData();
                
                // Если синхронизация включена, обновляем GitHub
                if (githubConfig.enabled && confirm("Также удалить из GitHub репозитория?")) {
                    pushToGitHub();
                }
                
                showSection('logs');
                showSyncMessage("Запись удалена", 'warning');
            }
        }
        
        // Очистить форму добавления
        function clearAddForm() {
            const title = document.getElementById('newTitle');
            const content = document.getElementById('newContent');
            const author = document.getElementById('newAuthor');
            const tags = document.getElementById('newTags');
            const date = document.getElementById('newDate');
            const priority = document.getElementById('newPriority');
            
            if (title) title.value = '';
            if (content) content.value = '';
            if (author) author.value = '';
            if (tags) tags.value = '';
            if (date) date.value = getCurrentDate();
            if (priority) priority.value = 'NORMAL';
        }
        
        // Сохранить настройки GitHub
        function saveGitHubConfig() {
            githubConfig = {
                token: document.getElementById('configToken')?.value.trim() || "",
                username: document.getElementById('configUsername')?.value.trim() || "",
                repo: document.getElementById('configRepo')?.value.trim() || "",
                branch: document.getElementById('configBranch')?.value.trim() || 'main',
                enabled: document.getElementById('configEnabled')?.checked || false
            };
            
            saveConfig();
            
            if (githubConfig.enabled) {
                testGitHubConnection();
            } else {
                showSyncMessage("Синхронизация отключена", 'warning');
            }
            
            updateSyncMode();
        }
        
        // Очистить настройки GitHub
        function clearGitHubConfig() {
            if (confirm("Очистить настройки GitHub?")) {
                githubConfig = {
                    token: "",
                    username: "",
                    repo: "",
                    branch: "main",
                    enabled: false
                };
                saveConfig();
                
                const token = document.getElementById('configToken');
                const username = document.getElementById('configUsername');
                const repo = document.getElementById('configRepo');
                const branch = document.getElementById('configBranch');
                const enabled = document.getElementById('configEnabled');
                
                if (token) token.value = '';
                if (username) username.value = '';
                if (repo) repo.value = '';
                if (branch) branch.value = 'main';
                if (enabled) enabled.checked = false;
                
                updateSyncMode();
                showSyncMessage("Настройки GitHub очищены", 'warning');
            }
        }
        
        // Проверить конфигурацию GitHub
        function checkGitHubConfig() {
            const statusEl = document.getElementById('githubStatus');
            const modeEl = document.getElementById('currentSyncMode');
            const repoStatusEl = document.getElementById('repoStatus');
            const syncModeEl = document.getElementById('syncMode');
            
            if (!statusEl || !modeEl || !repoStatusEl || !syncModeEl) return;
            
            if (!githubConfig.enabled || !githubConfig.token || !githubConfig.repo) {
                statusEl.textContent = "● ОТКЛЮЧЕНО";
                statusEl.style.color = "#FF0000";
                modeEl.textContent = "ОТКЛЮЧЕН";
                repoStatusEl.textContent = "● ЛОКАЛЬНЫЙ";
                repoStatusEl.style.color = "#FF0000";
                syncModeEl.textContent = "ЛОКАЛЬНЫЙ";
                return;
            }
            
            statusEl.textContent = "● ПРОВЕРКА...";
            statusEl.style.color = "#FFA500";
            
            // Тестируем подключение
            testGitHubConnection();
        }
        
        // Тест подключения к GitHub
        async function testGitHubConnection() {
            if (!githubConfig.enabled || !githubConfig.token || !githubConfig.repo) {
                showSyncMessage("Синхронизация отключена. Настройте GitHub API.", 'error');
                return false;
            }
            
            showSyncMessage("Тестирование подключения к GitHub...", 'syncing');
            
            try {
                const response = await fetch(`https://api.github.com/repos/${githubConfig.repo}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const statusEl = document.getElementById('githubStatus');
                    const repoStatusEl = document.getElementById('repoStatus');
                    
                    if (statusEl) {
                        statusEl.textContent = "● ПОДКЛЮЧЕНО";
                        statusEl.style.color = "#00FF00";
                    }
                    
                    if (repoStatusEl) {
                        repoStatusEl.textContent = `● ${githubConfig.repo}`;
                        repoStatusEl.style.color = "#00FF00";
                    }
                    
                    updateSyncMode();
                    showSyncMessage(`Подключение успешно: ${data.full_name}`, 'success');
                    return true;
                } else {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
            } catch (error) {
                showSyncMessage(`Ошибка подключения: ${error.message}`, 'error');
                
                const statusEl = document.getElementById('githubStatus');
                if (statusEl) {
                    statusEl.textContent = "● ОШИБКА";
                    statusEl.style.color = "#FF0000";
                }
                
                return false;
            }
        }
        
        // Синхронизировать с GitHub
        async function syncWithGitHub() {
            if (syncState.isSyncing) {
                showSyncMessage("Синхронизация уже выполняется...", 'warning');
                return;
            }
            
            if (!githubConfig.enabled) {
                showSyncMessage("Синхронизация отключена. Включите в настройках GitHub.", 'error');
                return;
            }
            
            syncState.isSyncing = true;
            showSyncMessage("Начало синхронизации...", 'syncing');
            
            try {
                // 1. Получаем текущий файл из GitHub
                const existingData = await getGitHubFile();
                
                // 2. Объединяем данные
                if (existingData) {
                    // Объединяем записи, избегая дубликатов
                    const existingIds = new Set(existingData.logs.map(log => log.id));
                    const newLogs = archiveData.logs.filter(log => !existingIds.has(log.id));
                    
                    if (newLogs.length > 0) {
                        existingData.logs.push(...newLogs);
                        archiveData = existingData;
                        saveLocalData();
                        showSyncMessage(`Добавлено ${newLogs.length} новых записей из GitHub`, 'success');
                    }
                }
                
                // 3. Загружаем обновленные данные в GitHub
                const success = await pushToGitHub();
                
                if (success) {
                    syncState.lastSync = new Date().toISOString();
                    updateLastSyncTime();
                    showSyncMessage("Синхронизация завершена успешно", 'success');
                    
                    // Обновляем интерфейс
                    updateLogsCount();
                    showSection('logs');
                }
                
            } catch (error) {
                console.error("Sync error:", error);
                showSyncMessage(`Ошибка синхронизации: ${error.message}`, 'error');
                
                // Добавляем в историю
                addSyncHistory('SYNC', false, error.message);
            } finally {
                syncState.isSyncing = false;
            }
        }
        
        // Получить файл из GitHub
        async function getGitHubFile() {
            if (!githubConfig.enabled) return null;
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.repo}/contents/${CONFIG.DATA_FILE}?ref=${githubConfig.branch}`,
                    {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.status === 404) {
                    // Файл не существует
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                const data = await response.json();
                const content = atob(data.content); // Декодируем base64
                return JSON.parse(content);
                
            } catch (error) {
                console.error("Error getting GitHub file:", error);
                throw error;
            }
        }
        
        // Загрузить данные в GitHub
        async function pushToGitHub() {
            if (!githubConfig.enabled) {
                showSyncMessage("Синхронизация отключена", 'error');
                return false;
            }
            
            showSyncMessage("Загрузка данных в GitHub...", 'syncing');
            
            try {
                // 1. Проверяем существование файла
                let sha = null;
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${githubConfig.repo}/contents/${CONFIG.DATA_FILE}?ref=${githubConfig.branch}`,
                        {
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha; // Нужен для обновления существующего файла
                    }
                } catch (e) {
                    // Файл не существует, это нормально
                }
                
                // 2. Подготавливаем данные
                archiveData.lastModified = new Date().toISOString();
                const content = JSON.stringify(archiveData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                
                // 3. Отправляем запрос
                const response = await fetch(
                    `https://api.github.com/repos/${githubConfig.repo}/contents/${CONFIG.DATA_FILE}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `KIPPT Archive Sync: ${new Date().toLocaleString()}`,
                            content: encodedContent,
                            sha: sha, // null для создания нового файла
                            branch: githubConfig.branch
                        })
                    }
                );
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `GitHub API error: ${response.status}`);
                }
                
                // Успех
                addSyncHistory('PUSH', true, `Загружено ${archiveData.logs.length} записей`);
                return true;
                
            } catch (error) {
                console.error("Error pushing to GitHub:", error);
                addSyncHistory('PUSH', false, error.message);
                showSyncMessage(`Ошибка загрузки: ${error.message}`, 'error');
                return false;
            }
        }
        
        // Загрузить данные из GitHub
        async function pullFromGitHub() {
            if (!githubConfig.enabled) {
                showSyncMessage("Синхронизация отключена", 'error');
                return;
            }
            
            showSyncMessage("Загрузка данных из GitHub...", 'syncing');
            
            try {
                const remoteData = await getGitHubFile();
                
                if (remoteData) {
                    // Объединяем данные
                    const localIds = new Set(archiveData.logs.map(log => log.id));
                    const newLogs = remoteData.logs.filter(log => !localIds.has(log.id));
                    
                    if (newLogs.length > 0) {
                        archiveData.logs.push(...newLogs);
                        saveLocalData();
                        showSyncMessage(`Добавлено ${newLogs.length} записей из GitHub`, 'success');
                    } else {
                        showSyncMessage("Новых записей на GitHub нет", 'info');
                    }
                    
                    addSyncHistory('PULL', true, `Загружено ${newLogs.length} записей`);
                } else {
                    showSyncMessage("Файл данных на GitHub не найден", 'warning');
                }
                
                // Обновляем интерфейс
                updateLogsCount();
                showSection('logs');
                
            } catch (error) {
                console.error("Error pulling from GitHub:", error);
                showSyncMessage(`Ошибка загрузки: ${error.message}`, 'error');
                addSyncHistory('PULL', false, error.message);
            }
        }
        
        // Принудительная пересинхронизация
        async function forceResync() {
            if (!confirm("Принудительная пересинхронизация заменит все локальные данные данными из GitHub. Продолжить?")) {
                return;
            }
            
            showSyncMessage("Принудительная пересинхронизация...", 'syncing');
            
            try {
                const remoteData = await getGitHubFile();
                
                if (remoteData) {
                    archiveData = remoteData;
                    saveLocalData();
                    
                    showSyncMessage("Данные полностью заменены с GitHub", 'success');
                    addSyncHistory('FORCE_RESYNC', true, "Полная пересинхронизация");
                } else {
                    showSyncMessage("Файл данных на GitHub не найден", 'error');
                }
                
                updateLogsCount();
                showSection('logs');
                
            } catch (error) {
                console.error("Force resync error:", error);
                showSyncMessage(`Ошибка: ${error.message}`, 'error');
            }
        }
        
        // Добавить запись в историю синхронизации
        function addSyncHistory(action, success, message) {
            const entry = {
                timestamp: new Date().toISOString(),
                action: action,
                success: success,
                message: message
            };
            
            archiveData.syncHistory.unshift(entry);
            
            // Ограничиваем историю 50 записями
            if (archiveData.syncHistory.length > 50) {
                archiveData.syncHistory = archiveData.syncHistory.slice(0, 50);
            }
            
            saveLocalData();
        }
        
        // Показать сообщение синхронизации
        function showSyncMessage(message, type) {
            const statusEl = document.getElementById('syncStatus');
            const messageEl = document.getElementById('syncMessage');
            
            if (!statusEl || !messageEl) return;
            
            statusEl.style.display = 'block';
            messageEl.textContent = `● ${message}`;
            
            switch(type) {
                case 'success':
                    messageEl.style.color = '#00FF00';
                    break;
                case 'error':
                    messageEl.style.color = '#FF0000';
                    break;
                case 'warning':
                    messageEl.style.color = '#FFA500';
                    break;
                case 'syncing':
                    messageEl.style.color = '#00FFFF';
                    messageEl.classList.add('syncing');
                    break;
                default:
                    messageEl.style.color = '#00FF00';
            }
            
            if (type !== 'syncing') {
                messageEl.classList.remove('syncing');
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Показать ошибку
        function showError(message) {
            alert(`ОШИБКА: ${message}`);
        }
        
        // Обновить счетчик записей
        function updateLogsCount() {
            const logsCountEl = document.getElementById('logsCount');
            if (logsCountEl) {
                logsCountEl.textContent = archiveData.logs.length;
            }
        }
        
        // Обновить время последней синхронизации
        function updateLastSyncTime() {
            const lastSyncEl = document.getElementById('lastSync');
            if (lastSyncEl) {
                lastSyncEl.textContent = 
                    syncState.lastSync ? 
                    new Date(syncState.lastSync).toLocaleDateString('ru-RU') : 
                    'НИКОГДА';
            }
            
            const lastSyncDetailEl = document.getElementById('lastSyncDetail');
            if (lastSyncDetailEl) {
                lastSyncDetailEl.textContent = 
                    syncState.lastSync ? 
                    new Date(syncState.lastSync).toLocaleString() : 
                    'НИКОГДА';
            }
        }
        
        // Обновить режим синхронизации
        function updateSyncMode() {
            const mode = githubConfig.enabled ? "СИНХРОНИЗАЦИЯ С ГИТХАБ" : "ЛОКАЛЬНЫЙ";
            const syncModeEl = document.getElementById('syncMode');
            const currentSyncModeEl = document.getElementById('currentSyncMode');
            
            if (syncModeEl) syncModeEl.textContent = mode;
            if (currentSyncModeEl) currentSyncModeEl.textContent = githubConfig.enabled ? 'АКТИВЕН' : 'ОТКЛЮЧЕН';
        }
        
        // Обновить дату и время
        function updateDateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', { hour12: false });
            const timeEl = document.getElementById('currentTime');
            
            if (timeEl) {
                timeEl.textContent = timeStr;
            }
        }
        
        // Получить текущую дату
        function getCurrentDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Генератор ID
        function generateId() {
            return 'KIPPT_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Ввод пароля по Enter
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
            }
            
            // Анимация тряски при ошибке
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Запуск инициализации после загрузки DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
